<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng & Thanh toán | SNEAKER SUPREME</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        if(!localStorage.getItem('user_login')) {
            alert("Vui lòng đăng nhập để xem giỏ hàng!");
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root { --red: #e60000; --black: #0a0a0a; --white: #fff; --momo: #a50064; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f8f8f8; padding-top: 80px; color: #333; }
        
        nav { background: var(--black); height: 80px; padding: 0 5%; position: fixed; top: 0; width: 100%; display: flex; align-items: center; justify-content: space-between; color: white; z-index: 1000; }
        .logo { font-weight: 900; font-size: 22px; text-decoration: none; color: white; }
        .logo span { color: var(--red); }
        
        .main { max-width: 1100px; margin: 40px auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; padding: 0 20px; }
        .box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .box h3 { border-bottom: 2px solid #f4f4f4; padding-bottom: 15px; margin-bottom: 20px; font-weight: 800; }
        
        .item { display: flex; gap: 15px; border-bottom: 1px solid #eee; padding: 15px 0; align-items: center; position: relative; }
        .item img { width: 90px; height: 90px; object-fit: contain; background: #f9f9f9; border-radius: 8px; }
        .item-info b { font-size: 15px; display: block; margin-bottom: 5px; }
        .item-info span { color: var(--red); font-weight: bold; }
        .item-info .size-tag { font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; }

        .btn-del { position: absolute; right: 0; top: 15px; color: #ccc; cursor: pointer; transition: 0.3s; }
        .btn-del:hover { color: var(--red); }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #666; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size: 14px; }

        .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; }
        .btn-checkout { width: 100%; background: var(--red); color: white; border: none; padding: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: 0.3s; }
        .btn-checkout:hover { background: #b30000; transform: translateY(-2px); }

        /* SUCCESS & MODAL OVERLAY */
        #success { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; color: white; text-align: center; padding-top: 150px; }
        #success i { font-size: 80px; color: #4CAF50; margin-bottom: 20px; }

        #paymentModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; }
        .qr-card { background:white; padding:30px; border-radius:15px; width:420px; text-align:center; position:relative; animation: slideUp 0.4s; }
        @keyframes slideUp { from{transform: translateY(50px); opacity: 0;} to{transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">SNEAKER<span>SUPREME</span></a>
        <a href="index.html" style="color:white; text-decoration:none;"><i class="fas fa-chevron-left"></i> TRỞ LẠI</a>
    </nav>

    <div class="main">
        <div>
            <div class="box" style="margin-bottom: 20px;">
                <h3>GIỎ HÀNG CỦA BẠN</h3>
                <div id="cart-list"></div>
            </div>

            <div class="box">
                <h3>THÔNG TIN GIAO HÀNG</h3>
                <div class="form-group">
                    <label>HỌ VÀ TÊN</label>
                    <input type="text" id="name" placeholder="Nhập tên người nhận">
                </div>
                <div class="form-group">
                    <label>SỐ ĐIỆN THOẠI</label>
                    <input type="text" id="phone" placeholder="Số điện thoại liên lạc">
                </div>
                <div class="form-group">
                    <label>ĐỊA CHỈ NHẬN HÀNG</label>
                    <input type="text" id="address" placeholder="Số nhà, tên đường, quận/huyện...">
                </div>
                <div class="form-group">
                    <label>PHƯƠNG THỨC THANH TOÁN</label>
                    <select id="method">
                        <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                        <option value="bank">Chuyển khoản ngân hàng (VietQR)</option>
                        <option value="momo">Ví điện tử MoMo</option>
                    </select>
                </div>
            </div>
        </div>

        <div>
            <div class="box" style="position: sticky; top: 100px;">
                <h3>TỔNG ĐƠN HÀNG</h3>
                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <b id="subtotal">0 ₫</b>
                </div>
                <div class="summary-row">
                    <span>Phí vận chuyển:</span>
                    <span style="color: green; font-weight: bold;">MIỄN PHÍ</span>
                </div>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
                <div class="summary-row" style="font-weight: 800; font-size: 22px;">
                    <span>Tổng tiền:</span>
                    <span id="final-total" style="color:var(--red)">0 ₫</span>
                </div>

                <button class="btn-checkout" onclick="processOrder()">XÁC NHẬN ĐẶT HÀNG</button>
            </div>
        </div>
    </div>

    <div id="paymentModal">
        <div class="qr-card">
            <i class="fas fa-times" onclick="closePayment()" style="position:absolute; top:15px; right:20px; cursor:pointer; font-size:20px; color:#888;"></i>
            <h3 style="margin-bottom:20px; font-weight: 800;">THANH TOÁN ONLINE</h3>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="showQR('bank')" id="btnBank" style="flex:1; padding:12px; cursor:pointer; border:1px solid #ddd; border-radius:8px; font-weight:bold;">NGÂN HÀNG</button>
                <button onclick="showQR('momo')" id="btnMomo" style="flex:1; padding:12px; cursor:pointer; border:1px solid #ddd; border-radius:8px; font-weight:bold;">VÍ MOMO</button>
            </div>

            <div id="qrContent">
                <div id="bankInfo">
                    <p style="font-size:13px; margin-bottom:10px;">Quét VietQR để chuyển khoản qua <b>MB Bank</b></p>
                    <img id="bankQR" src="" style="width:220px; border:1px solid #eee; padding:5px; border-radius:8px;">
                    <div style="text-align:left; background:#f8f8f8; padding:12px; margin-top:15px; border-radius:8px; font-size:13px; line-height: 1.6;">
                        <p>STK: <b>0123456789999</b></p>
                        <p>Chủ TK: <b>NGUYEN VAN A</b></p>
                        <p>Nội dung: <b id="payCode" style="color:var(--red)"></b></p>
                    </div>
                </div>
                
                <div id="momoInfo" style="display:none">
                    <p style="font-size:13px; margin-bottom:10px; color:var(--momo);">Thanh toán qua <b>Ví MOMO</b></p>
                    <img id="momoQR" src="" style="width:220px; border:1px solid #eee; padding:5px; border-radius:8px;">
                    <p style="margin-top:10px; font-weight:bold; color:var(--momo); font-size:18px;">0909 123 456</p>
                    <p style="font-size:12px; color:#888;">Nội dung ghi chú: [Tên của bạn]</p>
                </div>
            </div>

            <button onclick="confirmPaid()" style="width:100%; margin-top:20px; padding:16px; background:var(--black); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">TÔI ĐÃ CHUYỂN KHOẢN XONG</button>
        </div>
    </div>

    <div id="success">
        <i class="fas fa-check-circle"></i>
        <h2>ĐẶT HÀNG THÀNH CÔNG!</h2>
        <p style="margin: 15px 0; color: #ccc;">Đơn hàng của bạn đang được bộ phận kho xử lý.</p>
        <button onclick="window.location.href='index.html'" style="margin-top:30px; padding:15px 40px; border-radius:30px; border:none; cursor:pointer; font-weight:bold; background: white; color: black;">VỀ TRANG CHỦ</button>
    </div>

    <script>
        // 1. Tải giỏ hàng từ LocalStorage
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const list = document.getElementById('cart-list');
            let total = 0;

            if(cart.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:50px;">
                    <i class="fas fa-shopping-basket" style="font-size:50px; color:#ddd; margin-bottom:15px;"></i>
                    <p style="color:#999">Giỏ hàng trống. Tiếp tục mua sắm nhé!</p>
                </div>`;
                updateTotal(0);
                return;
            }

            list.innerHTML = cart.map((item, index) => {
                total += item.p;
                return `
                    <div class="item">
                        <img src="${item.img}">
                        <div class="item-info">
                            <b>${item.n}</b>
                            <span class="size-tag">Size: ${item.size || 'N/A'}</span>
                            <div style="margin-top:8px;"><span>${item.p.toLocaleString()} ₫</span></div>
                        </div>
                        <i class="fas fa-trash-alt btn-del" onclick="removeItem(${index})"></i>
                    </div>
                `;
            }).join('');

            updateTotal(total);
        }

        function updateTotal(total) {
            document.getElementById('subtotal').innerText = total.toLocaleString() + ' ₫';
            document.getElementById('final-total').innerText = total.toLocaleString() + ' ₫';
        }

        function removeItem(idx) {
            let cart = JSON.parse(localStorage.getItem('cart'));
            cart.splice(idx, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        // 2. Xử lý đặt hàng
        function processOrder() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const addr = document.getElementById('address').value;
            const method = document.getElementById('method').value;

            if(cart.length === 0) return alert("Giỏ hàng đang trống!");
            if(!name || !phone || !addr) return alert("Vui lòng nhập đầy đủ thông tin giao hàng!");

            if(method === 'cod') {
                // Nếu là COD, hiện thông báo thành công luôn
                showSuccessUI();
            } else {
                // Nếu chọn Online, hiện Modal QR
                openPayment(method);
            }
        }

        // 3. Logic QR Thanh toán
        function openPayment(method) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            let total = 0;
            cart.forEach(item => total += item.p);

            const user = localStorage.getItem('user_login');
            const code = "SS" + Math.floor(Math.random() * 90000 + 10000);
            
            document.getElementById('payCode').innerText = user + " " + code;
            
            // VietQR API
            document.getElementById('bankQR').src = `https://img.vietqr.io/image/MB-0123456789999-compact.png?amount=${total}&addInfo=${user}%20${code}`;
            
            // Momo QR (Dùng số của bạn)
            document.getElementById('momoQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=2|99|0909123456|||0|0|${total}|${user}%20${code}|transfer_myqr`;

            document.getElementById('paymentModal').style.display = 'flex';
            showQR(method === 'bank' ? 'bank' : 'momo');
        }

        function showQR(type) {
            const bInfo = document.getElementById('bankInfo');
            const mInfo = document.getElementById('momoInfo');
            const btnB = document.getElementById('btnBank');
            const btnM = document.getElementById('btnMomo');

            if(type === 'bank') {
                bInfo.style.display = 'block'; mInfo.style.display = 'none';
                btnB.style.background = 'var(--red)'; btnB.style.color = 'white';
                btnM.style.background = '#f9f9f9'; btnM.style.color = '#333';
            } else {
                bInfo.style.display = 'none'; mInfo.style.display = 'block';
                btnM.style.background = 'var(--momo)'; btnM.style.color = 'white';
                btnB.style.background = '#f9f9f9'; btnB.style.color = '#333';
            }
        }

        function closePayment() { document.getElementById('paymentModal').style.display = 'none'; }

        function confirmPaid() {
            alert("Thông báo thanh toán đã được gửi đi. Chúng tôi sẽ duyệt đơn ngay!");
            closePayment();
            showSuccessUI();
        }

        function showSuccessUI() {
            localStorage.setItem('cart', JSON.stringify([])); // Xóa giỏ hàng
            document.getElementById('success').style.display = 'block';
        }

        window.onload = loadCart;
    </script>
</body>
</html>