<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán | GIAY CHAT 2036</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --red: #e60000; --black: #0a0a0a; --white: #fff; --overlay: rgba(0,0,0,0.7); --momo: #a50064; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #fcfcfc; color: #333; overflow-x: hidden; padding-top: 80px; }

        /* NAVBAR - GIỐNG HỆT INDEX & DETAIL */
        nav { background: var(--black); height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .logo { color: var(--white); font-size: 24px; font-weight: 900; letter-spacing: 1px; }
        .logo span { color: var(--red); }
        .nav-center { display: flex; align-items: center; gap: 15px; flex-grow: 1; justify-content: center; }
        .search-box { position: relative; width: 100%; max-width: 400px; }
        .search-box input { width: 100%; padding: 12px 40px 12px 20px; border-radius: 30px; border: none; background: #222; color: white; outline: none; transition: 0.3s; }
        .search-box i { position: absolute; right: 15px; top: 12px; color: #777; pointer-events: none; }
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .nav-right a, .nav-btn { color: var(--white); font-size: 20px; cursor: pointer; position: relative; transition: 0.3s; background: none; border: none; }
        .badge { position: absolute; top: -8px; right: -10px; background: var(--red); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; }

        /* MOBILE SEARCH */
        #mobile-search-btn { display: none; }
        .mobile-search-container { position: fixed; top: 80px; left: 0; width: 100%; background: var(--black); z-index: 999; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .mobile-search-container.active { display: block; }
        .mobile-search-box { position: relative; padding: 15px 5%; }
        .mobile-search-box input { width: 100%; padding: 14px 50px 14px 20px; border-radius: 30px; border: none; background: #222; color: white; outline: none; font-size: 16px; }
        .mobile-search-box i.fa-search { position: absolute; right: 10%; top: 50%; transform: translateY(-50%); color: #777; pointer-events: none; }
        .mobile-search-box i.fa-times { position: absolute; right: 5%; top: 50%; transform: translateY(-50%); color: #777; cursor: pointer; }

        /* SIDEBAR - TRANSFORM NHƯ INDEX & DETAIL */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 380px;
            height: 100vh;
            background: white;
            z-index: 2000;
            padding: 20px;
            box-shadow: -10px 0 30px rgba(0,0,0,0.25);
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.4s ease-in-out;
        }
        .history-sidebar,
        .user-sidebar {
            left: auto;
            right: 0;
            transform: translateX(100%);
            box-shadow: 10px 0 30px rgba(0,0,0,0.25);
        }
        .history-sidebar.active,
        .user-sidebar.active {
            transform: translateX(0);
        }
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--overlay);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s ease, visibility 0s linear 0.35s;
        }
        .overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.35s ease, visibility 0s linear 0s;
        }
        .f-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }

        /* MAIN CART - GIỮ NGUYÊN VÀ TỐI ƯU */
        .main { max-width: 1200px; margin: 40px auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; padding: 0 5%; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .box h3 { border-bottom: 2px solid #f9f9f9; padding-bottom: 15px; margin-bottom: 20px; font-weight: 800; font-size: 18px; text-transform: uppercase; }

        .item { display: flex; gap: 15px; border-bottom: 1px solid #f0f0f0; padding: 15px 0; align-items: center; position: relative; }
        .item img { width: 80px; height: 80px; object-fit: contain; background: #f9f9f9; border-radius: 10px; }
        .item-info b { font-size: 14px; display: block; margin-bottom: 4px; }
        .item-info span { color: var(--red); font-weight: bold; font-size: 15px; }
        .size-tag { font-size: 11px; background: #eee; padding: 2px 8px; border-radius: 4px; color: #555; margin-left: 5px; }
        .btn-del { position: absolute; right: 5px; top: 15px; color: #ddd; cursor: pointer; transition: 0.3s; }
        .btn-del:hover { color: var(--red); }

        .payment-method-item { display: flex; align-items: center; gap: 15px; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: 0.3s; }
        .payment-method-item:hover { border-color: #ccc; }
        .payment-method-item.active { border-color: var(--red); background: #fff5f5; }
        .payment-method-item i { font-size: 20px; width: 30px; text-align: center; }
        .payment-method-item .check-icon { font-size: 18px; }

        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; }
        .btn-checkout { width: 100%; background: var(--black); color: white; border: none; padding: 20px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: 0.3s; letter-spacing: 1px; text-transform: uppercase; }
        .btn-checkout:hover { background: var(--red); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(230,0,0,0.3); }

        /* MODALS */
        #paymentModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; }
        .qr-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; position: relative; }
        #success { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--black); z-index: 10000; color: white; text-align: center; padding-top: 150px; }
        #success i { font-size: 70px; color: #00ff00; margin-bottom: 20px; }

        footer { background: #0a0a0a; color: #888; padding: 40px 5%; text-align: center; border-top: 5px solid #e60000; margin-top: 80px; }

        /* RESPONSIVE */
        @media (min-width: 769px) {
            .search-box { width: 250px; }
        }
        @media (max-width: 768px) {
            nav { padding: 0 3%; }
            .nav-center { display: none; }
            #mobile-search-btn { display: block; }
            .main { grid-template-columns: 1fr; gap: 25px; }
            .box:nth-child(2) { position: static; }
        }
        @media (max-width: 480px) {
            body { padding-top: 70px; }
            nav { height: 70px; }
            .logo { font-size: 18px; }
            .mobile-search-container { top: 70px; }
            .mobile-search-box { padding: 10px 3%; }
            .item img { width: 70px; height: 70px; }
        }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="closeAllSidebars()"></div>

    <!-- Mobile Search -->
    <div class="mobile-search-container" id="mobile-search-container">
        <div class="mobile-search-box">
            <input type="text" id="mobile-search-input" placeholder="Tìm kiếm giày..." autocomplete="off">
            <i class="fas fa-search"></i>
            <i class="fas fa-times" onclick="closeMobileSearch()"></i>
        </div>
    </div>

    <!-- History Sidebar -->
    <div class="sidebar history-sidebar" id="history-sidebar">
        <div class="f-header"><h3>VỪA XEM</h3><i class="fas fa-times" onclick="closeAllSidebars()"></i></div>
        <div id="history-list"></div>
    </div>

    <!-- User Sidebar -->
    <div class="sidebar user-sidebar" id="user-sidebar">
        <div class="f-header"><h3>THÔNG TIN GIAO HÀNG</h3><i class="fas fa-times" onclick="closeAllSidebars()"></i></div>
        <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; font-size:13px; margin-bottom:15px;">
            <i class="fas fa-exclamation-circle"></i> Vui lòng điền đầy đủ thông tin bên dưới để thêm vào giỏ hàng.
        </div>
        <div id="user-info-content" style="font-size:14px;">
            <form onsubmit="saveUserInfo(event)">
                <div class="inp-group"><label>Họ tên *</label><input type="text" id="inp-name" required></div>
                <div class="inp-group"><label>Số điện thoại *</label><input type="tel" id="inp-phone" required></div>
                <div class="inp-group"><label>Địa chỉ nhận hàng *</label><input type="text" id="inp-address" required placeholder="Số nhà, đường..."></div>
                <div class="inp-group"><label>Tỉnh / Thành phố *</label><input type="text" id="inp-city" required></div>
                <button type="submit" style="width:100%; padding:12px; background:var(--black); color:white; border:none; border-radius:6px; cursor: pointer;">LƯU VÀ TIẾP TỤC</button>
            </form>
            <p style="font-size:12px; color:#999; margin-top:15px; text-align:center">Thông tin này dùng để tạo đơn hàng nhanh chóng.</p>
            <button onclick="logout()" style="width:100%; margin-top:10px; padding:10px; border:1px solid var(--red); color:var(--red); background:none; cursor:pointer; border-radius:6px">ĐĂNG XUẤT</button>
        </div>
    </div>

    <!-- Navbar giống index/detail -->
    <nav>
        <a href="index.html" class="logo">GIAY<span>CHAT</span></a>
        <div class="nav-center">
            <div class="search-box">
                <input type="text" id="search-inp" placeholder="Tìm kiếm sản phẩm..." autocomplete="off">
                <i class="fas fa-search"></i>
            </div>
        </div>
        <div class="nav-right">
            <a href="index.html"><i class="fas fa-home"></i></a>
            <button class="nav-btn" id="mobile-search-btn" onclick="toggleMobileSearch()"><i class="fas fa-search"></i></button>
            <button class="nav-btn" onclick="toggleHistory()"><i class="fas fa-history"></i></button>
            <a href="javascript:void(0)" onclick="checkCartAccess()" style="position:relative">
                <i class="fas fa-shopping-bag"></i> <span class="badge" id="cart-cnt">0</span>
            </a>
            <div id="user-area"></div>
        </div>
    </nav>

    <!-- Main Cart - GIỮ NGUYÊN CẤU TRÚC -->
    <div class="main">
        <div>
            <div class="box" style="margin-bottom: 25px;">
                <h3>Sản phẩm đã chọn</h3>
                <div id="cart-list"></div>
            </div>

            <div class="box">
                <h3>Chọn phương thức thanh toán</h3>
                
                <label class="payment-method-item active" onclick="selectMethod(this, 'cod')">
                    <i class="fas fa-truck" style="color: #555;"></i>
                    <div style="flex:1">
                        <b>Thanh toán khi nhận hàng (COD)</b>
                        <p style="font-size:12px; color:#888;">Trả tiền mặt khi shipper giao hàng</p>
                    </div>
                    <i class="fas fa-check-circle check-icon" style="color:var(--red)"></i>
                </label>

                <label class="payment-method-item" onclick="selectMethod(this, 'bank')">
                    <i class="fas fa-university" style="color: #0056b3;"></i>
                    <div style="flex:1">
                        <b>Chuyển khoản Ngân hàng</b>
                        <p style="font-size:12px; color:#888;">Quét mã VietQR (Xử lý nhanh)</p>
                    </div>
                    <i class="fas fa-circle check-icon" style="color:#eee"></i>
                </label>

                <label class="payment-method-item" onclick="selectMethod(this, 'momo')">
                    <i class="fab fa-google-pay" style="color: var(--momo); font-size: 25px;"></i>
                    <div style="flex:1">
                        <b>Ví điện tử MoMo</b>
                        <p style="font-size:12px; color:#888;">Thanh toán qua ứng dụng MoMo</p>
                    </div>
                    <i class="fas fa-circle check-icon" style="color:#eee"></i>
                </label>
            </div>
        </div>

        <div>
            <div class="box" style="position: sticky; top: 100px;">
                <h3>Tóm tắt đơn hàng</h3>
                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <b id="subtotal">0 ₫</b>
                </div>
                <div class="summary-row">
                    <span>Phí vận chuyển:</span>
                    <span style="color: #00a651; font-weight: bold;">Miễn phí</span>
                </div>
                <div class="summary-row" style="margin-top:20px; border-top: 1px dashed #ddd; padding-top:20px;">
                    <span style="font-weight:bold">TỔNG CỘNG:</span>
                    <b id="final-total" style="color:var(--red); font-size: 24px;">0 ₫</b>
                </div>

                <button class="btn-checkout" onclick="handleCheckout()">HOÀN TẤT ĐẶT HÀNG</button>
                
                <p style="font-size:12px; color:#999; margin-top:15px; text-align:center; line-height:1.4;">
                    Bằng cách nhấn đặt hàng, bạn đồng ý với các điều khoản bảo mật thông tin của Sneaker Supreme.
                </p>
            </div>
        </div>
    </div>

    <!-- Payment Modal & Success - GIỮ NGUYÊN -->
    <div id="paymentModal">
        <div class="qr-card">
            <i class="fas fa-times" onclick="closePayment()" style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:20px; color:#ccc;"></i>
            <h3 id="qr-title" style="margin-bottom:10px;">QUÉT MÃ THANH TOÁN</h3>
            <p id="qr-subtitle" style="font-size:13px; color:#666; margin-bottom:20px;">Nội dung: <b id="pay-content" style="color:var(--red)"></b></p>
            
            <img id="qr-image" src="" style="width:250px; border-radius:10px; border:1px solid #eee; padding:10px;">
            
            <div style="margin-top:20px;">
                <button onclick="confirmPaid()" style="width:100%; padding:15px; background:var(--black); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">TÔI ĐÃ CHUYỂN KHOẢN</button>
                <p style="font-size:12px; color:#999; margin-top:10px;">Hệ thống sẽ tự động xác nhận sau 1-3 phút.</p>
            </div>
        </div>
    </div>

    <div id="success">
        <div style="margin-top: 50px;">
            <i class="fas fa-check-circle"></i>
            <h2 style="font-size:30px; letter-spacing:2px;">CẢM ƠN BẠN!</h2>
            <p style="margin: 20px 0; color: #888;">Đơn hàng đã được ghi nhận. Chúng tôi sẽ sớm liên hệ xác nhận.</p>
            <button onclick="window.location.href='index.html'" style="padding:15px 40px; border-radius:30px; border:none; cursor:pointer; font-weight:bold; background: var(--red); color: white;">TIẾP TỤC MUA SẮM</button>
        </div>
    </div>

    <footer>
        &copy; 2036 GIAY CHAT. All rights reserved.
    </footer>

    <script>
        // Bảo mật login - GIỮ NGUYÊN
        if(!localStorage.getItem('user_login')) {
            alert("Vui lòng đăng nhập để thanh toán!");
            window.location.href = 'login.html';
        }

        let currentMethod = 'cod';

        // Logic cart - GIỮ NGUYÊN HOÀN TOÀN
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const list = document.getElementById('cart-list');
            let total = 0;

            if(cart.length === 0) {
                list.innerHTML = `<p style="text-align:center; padding:30px; color:#999;">Giỏ hàng trống.</p>`;
                updateTotal(0);
                updateUI();
                return;
            }

            list.innerHTML = cart.map((item, index) => {
                total += item.p;
                return `
                    <div class="item">
                        <img src="${item.img}">
                        <div class="item-info">
                            <b>${item.n}</b>
                            <p style="font-size:12px; color:#777;">Size: ${item.size} <span class="size-tag">Hàng sẵn</span></p>
                            <div style="margin-top:5px;"><span>${item.p.toLocaleString()} ₫</span></div>
                        </div>
                        <i class="fas fa-times btn-del" onclick="removeItem(${index})" title="Xóa"></i>
                    </div>
                `;
            }).join('');
            updateTotal(total);
            updateUI();
        }

        function updateTotal(total) {
            document.getElementById('subtotal').innerText = total.toLocaleString() + ' ₫';
            document.getElementById('final-total').innerText = total.toLocaleString() + ' ₫';
        }

        function removeItem(idx) {
            let cart = JSON.parse(localStorage.getItem('cart'));
            cart.splice(idx, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        function selectMethod(el, method) {
            document.querySelectorAll('.payment-method-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.check-icon').className = 'fas fa-circle check-icon';
                item.querySelector('.check-icon').style.color = '#eee';
            });
            el.classList.add('active');
            el.querySelector('.check-icon').className = 'fas fa-check-circle check-icon';
            el.querySelector('.check-icon').style.color = 'var(--red)';
            currentMethod = method;
        }

        function handleCheckout() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if(cart.length === 0) return alert("Giỏ hàng của bạn đang trống!");

            if(currentMethod === 'cod') {
                showSuccess();
            } else {
                openQRModal();
            }
        }

        function openQRModal() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            let total = 0; cart.forEach(i => total += i.p);
            
            const user = localStorage.getItem('user_login') || 'GUEST';
            const code = "SUP" + Math.floor(Math.random()*9000 + 1000);
            document.getElementById('pay-content').innerText = user + " " + code;

            if(currentMethod === 'bank') {
                document.getElementById('qr-title').innerText = "CHUYỂN KHOẢN MB BANK";
                document.getElementById('qr-image').src = `https://img.vietqr.io/image/MB-0123456789999-compact.png?amount=${total}&addInfo=${user}%20${code}`;
            } else {
                document.getElementById('qr-title').innerText = "THANH TOÁN MOMO";
                document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=2|99|0909123456|||0|0|${total}|${user}%20${code}|transfer_myqr`;
            }

            document.getElementById('paymentModal').style.display = 'flex';
        }

        function closePayment() { document.getElementById('paymentModal').style.display = 'none'; }

        function confirmPaid() {
            alert("Đã gửi yêu cầu xác nhận thanh toán!");
            closePayment();
            showSuccess();
        }

        function showSuccess() {
            localStorage.setItem('cart', '[]');
            document.getElementById('success').style.display = 'block';
        }

        // Thêm các hàm sidebar & UI giống index/detail
        function toggleMobileSearch() {
            const container = document.getElementById('mobile-search-container');
            container.classList.toggle('active');
            if (container.classList.contains('active')) {
                document.getElementById('mobile-search-input').focus();
            }
        }

        function closeMobileSearch() {
            document.getElementById('mobile-search-container').classList.remove('active');
        }

        function closeAllSidebars() {
            document.querySelectorAll('.sidebar').forEach(s => s.classList.remove('active'));
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleHistory() {
            // Logic history giống detail (có thể copy từ detail nếu cần đầy đủ)
            closeAllSidebars();
            document.getElementById('history-sidebar').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function updateUI() {
            const u = localStorage.getItem('user_login');
            document.getElementById('user-area').innerHTML = u
                ? `<button class="nav-btn" onclick="document.getElementById('user-sidebar').classList.add('active');document.getElementById('overlay').classList.add('active');"><i class="fas fa-user-circle"></i></button>`
                : `<a href="login.html" class="nav-btn"><i class="far fa-user"></i></a>`;
            const cartCnt = JSON.parse(localStorage.getItem('cart') || '[]').length;
            document.getElementById('cart-cnt').innerText = cartCnt;
        }

        function checkCartAccess() {
            // Đã ở trang cart rồi, không cần redirect
        }

        window.onload = () => {
            loadCart();
            updateUI();
        };
    </script>
</body>
</html>